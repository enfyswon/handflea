<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="ProductMapper">

	<select id="detail" parameterType="java.lang.String" resultType="kr.co.handflea.product.ProductDTO">
	select p.prdt_no, p.prdt_name, p.mem_no, m.mem_email, p.price, p.delivery_price
		, p.description, p.view_cnt, p.reg_date
		, p.thumbnail_name, p.thumbnail_path, p.prdt_img_name, p.prdt_img_path
		, p.desc_img_name, p.desc_img_path, p.prdt_rdy, p.option_yn, p.bigcate_no, p.smallcate_no 
    	from product p, member m
    	where p.prdt_no = #{prdt_no}
		and del_yn = 0
		and p.mem_no = m.mem_no
	</select>

	<select id="main"  resultType="kr.co.handflea.product.ProductDTO">
	select p.prdt_no, p.prdt_name, p.mem_no, m.mem_email, p.price, p.delivery_price
		, p.description, p.view_cnt, p.reg_date
		, p.thumbnail_name, p.thumbnail_path, p.prdt_img_name, p.prdt_img_path
		, p.desc_img_name, p.desc_img_path, p.prdt_rdy, p.option_yn, p.bigcate_no, p.smallcate_no 
    	from product p, member m
		where del_yn = 0
		and p.mem_no = m.mem_no
		order by prdt_no desc
		
	</select>

	<update id="incrementViewCnt" parameterType="java.lang.String">
	update product
	set view_cnt = view_cnt + 1
	where prdt_no = #{prdt_no}
	</update>
	
	<select id="selectList" parameterType="kr.co.handflea.util.dto.SearchDTO"
			resultType="kr.co.handflea.product.ProductDTO">
		select p.prdt_no, p.prdt_name, p.mem_no, m.mem_email, p.price, p.delivery_price
		, p.description, p.view_cnt, p.reg_date
		, p.thumbnail_name, p.thumbnail_path, p.prdt_img_name, p.prdt_img_path
		, p.desc_img_name, p.desc_img_path, p.prdt_rdy, p.option_yn, p.bigcate_no, p.smallcate_no 
    	from product p, member m
		where del_yn = 0
		<if test="searchOption != null and searchOption != ''
					and searchWord != null and searchWord !=''">
			<choose>
				<when test="searchOption == 'prdt_name'">
					and p.prdt_name like concat('%', #{searchWord}, '%')
				</when>
				<when test="searchOption == 'mem_email'">
					and m.mem_email like concat('%', #{searchWord}, '%')
				</when>
			</choose>
		</if>
		and p.mem_no = m.mem_no
		order by prdt_no desc
		limit #{limitNum}, 8
	</select>
	
	<select id="searchListCount" parameterType="kr.co.handflea.util.dto.SearchDTO" resultType="int">
		select count(p.prdt_no) cnt
		from product p, member m
		where del_yn = 0
		<if test="searchOption != null and searchOption != ''
					and searchWord != null and searchWord !=''">
			<choose>
				<when test="searchOption == 'prdt_name'">
					and p.prdt_name like concat('%', #{searchWord}, '%')
				</when>
				<when test="searchOption == 'mem_email'">
					and mem_email like concat('%', #{searchWord}, '%')
				</when>
			</choose>
		</if>
		and p.mem_no = m.mem_no
	</select>

	<insert id="option_insert" parameterType="kr.co.handflea.product.ProductDTO">
	insert into prdt_option (prdt_no, option_contents)
	values
		<foreach item="item" collection="arr_option" separator=",">
			( #{prdt_no}, #{item} )
		</foreach>
	</insert>

	<insert id="insert" parameterType="kr.co.handflea.product.ProductDTO">
	insert into product (prdt_name, mem_no, price, delivery_price, description, reg_date
						, thumbnail_name, thumbnail_path, prdt_img_name, prdt_img_path
						, desc_img_name, desc_img_path, prdt_rdy, option_yn, bigcate_no, smallcate_no)
	values(#{prdt_name}, #{mem_no}, #{price}, #{delivery_price}, #{description}, now()
			, #{thumbnail_name}, #{thumbnail_path}, #{prdt_img_name}, #{prdt_img_path}
			, #{desc_img_name}, #{desc_img_path}, #{prdt_rdy}, #{option_yn}, #{bigcate_no}, #{smallcate_no}) 
		<selectKey resultType="String" keyProperty="prdt_no" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<select id="smallcateSelect" parameterType="java.lang.String" resultType="kr.co.handflea.product.ProductDTO">
	select smallcate_no, smallcate_name
	from smallcate
	where bigcate_no = #{bigcate_no}
	</select>

	<select id="bigcateSelect" resultType="kr.co.handflea.product.ProductDTO">
	select bigcate_no, bigcate_name
	from bigcate
	order by bigcate_no
	</select>
</mapper>